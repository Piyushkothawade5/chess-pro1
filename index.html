<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chess Trainer Pro</title>

<link rel="manifest" href="manifest.json">

<link rel="stylesheet"
href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<style>
body{margin:0;background:#121212;color:white;font-family:Arial;text-align:center}
#board{width:95vw;max-width:480px;margin:auto}
button{padding:6px 10px;margin:3px;font-size:13px}
#moves{height:130px;overflow:auto;background:#1e1e1e;margin-top:6px;font-size:12px}
#evalbar{width:18px;height:480px;background:#444;position:absolute;left:5px;top:70px}
#evalfill{width:100%;height:50%;background:white}
#stats{font-size:13px;margin-top:4px}
#clock{font-size:14px;margin-top:6px}
</style>
</head>

<body>

<h2>â™Ÿ Chess Trainer Pro</h2>

<div style="position:relative;display:inline-block">
  <div id="evalbar"><div id="evalfill"></div></div>
  <div id="board"></div>
</div>

<br>

<button onclick="hint()">Hint</button>
<button onclick="playAI()">AI</button>
<button onclick="review()">Review</button>
<button onclick="puzzle()">Puzzle</button>
<button onclick="undo()">Undo</button>
<button onclick="reset()">Reset</button>
<button onclick="exportPGN()">PGN</button>
<button onclick="toggleTheme()">Theme</button>

<div id="clock">Time: 5:00</div>
<div id="stats"></div>
<div id="moves"></div>

<script>
let game=new Chess();
let board;
let history=[];
let evalBefore=0;
let bestMove=null;

const engine=new Worker("https://cdn.jsdelivr.net/npm/stockfish/stockfish.js");

board=Chessboard('board',{
 draggable:true,
 position:'start',
 onDrop:onDrop
});

//////////////////////
// ENGINE
//////////////////////

let currentEval=0;
let analysing=false;
let hintMode=false;
let aiMode=false;

engine.onmessage=function(e){
 let line=e.data;

 if(line.includes("score cp")){
   currentEval=parseInt(line.split("cp")[1]);
   updateEval(currentEval);
 }

 if(line.startsWith("bestmove")){
   bestMove=line.split(" ")[1];

   if(hintMode){
     drawArrow(bestMove);
     hintMode=false;
   }
   if(aiMode){
     makeMove(bestMove);
     aiMode=false;
   }
 }
};

function analyse(){
 engine.postMessage("position fen "+game.fen());
 engine.postMessage("go depth 16");
}

//////////////////////
// MOVES
//////////////////////

function onDrop(s,t){
 let move=game.move({from:s,to:t,promotion:'q'});
 if(move===null) return 'snapback';

 history.push({san:move.san,before:evalBefore});
 evalBefore=currentEval;

 updateMoves();
 analyse();
}

function makeMove(m){
 game.move({from:m.slice(0,2),to:m.slice(2,4),promotion:'q'});
 board.position(game.fen());
 updateMoves();
}

function updateMoves(){
 document.getElementById("moves").innerHTML=
 history.map((x,i)=>(i+1)+". "+x.san).join("<br>");
}

//////////////////////
// EVAL BAR
//////////////////////

function updateEval(score){
 let percent=50+score/10;
 percent=Math.max(0,Math.min(100,percent));
 document.getElementById("evalfill").style.height=percent+"%";
}

//////////////////////
// HINT ARROW
//////////////////////

function drawArrow(move){
 alert("Best move: "+move);
}

function hint(){hintMode=true;analyse();}
function playAI(){aiMode=true;analyse();}

//////////////////////
// REVIEW (REAL)
//////////////////////

function classify(diff){
 if(diff<20)return"Best";
 if(diff<60)return"Good";
 if(diff<150)return"Inaccuracy";
 if(diff<400)return"Mistake";
 return"Blunder";
}

function review(){
 let acc=0;
 let labels=[];

 for(let m of history){
   let diff=Math.abs(currentEval-m.before);
   let c=classify(diff);
   labels.push(c);
   if(c==="Best"||c==="Good")acc++;
 }

 acc=Math.round(acc/history.length*100);
 document.getElementById("stats").innerHTML=
 "Accuracy: "+acc+"%<br>"+labels.join(" | ");
}

//////////////////////
// PUZZLE MODE
//////////////////////

function puzzle(){
 reset();
 alert("Puzzle: find best move!");
 hint();
}

//////////////////////
// TIMER
//////////////////////

let time=300;
setInterval(()=>{
 if(time>0){
  time--;
  let m=Math.floor(time/60);
  let s=time%60;
  document.getElementById("clock").innerText="Time: "+m+":"+String(s).padStart(2,'0');
 }
},1000);

//////////////////////
// CONTROLS
//////////////////////

function undo(){game.undo();history.pop();board.position(game.fen());updateMoves();}
function reset(){game.reset();history=[];board.start();updateMoves();document.getElementById("stats").innerHTML="";}

//////////////////////
// PGN
//////////////////////

function exportPGN(){
 navigator.clipboard.writeText(game.pgn());
 alert("PGN copied!");
}

//////////////////////
// THEME
//////////////////////

let dark=true;
function toggleTheme(){
 dark=!dark;
 document.body.style.background=dark?"#121212":"#eee";
 document.body.style.color=dark?"white":"black";
}
</script>
</body>
</html>
